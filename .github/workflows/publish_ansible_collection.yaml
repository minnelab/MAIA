name: Publish Ansible Collection

on:
  push:
    branches:
      - main
      - master

jobs:
  publish-ansible-collection:
    # Only run if commit message matches pattern "Ansible MAIA.Installation v<VERSION>"
    if: startsWith(github.event.head_commit.message, 'Ansible MAIA.Installation v')
    name: Build and publish Ansible collection to Galaxy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core
      
      - name: Extract version from commit message
        id: extract_version
        run: |
          # Extract version from commit message format: "Ansible MAIA.Installation v<VERSION>"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"
          
          # Use regex to extract version (remove 'v' prefix)
          VERSION=$(echo "$COMMIT_MSG" | sed -n 's/^Ansible MAIA\.Installation v\([0-9.]*\).*/\1/p')
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not extract version from commit message"
            exit 1
          fi
          
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update galaxy.yml version
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          echo "Updating galaxy.yml with version: $VERSION"
          
          # Update the version field in galaxy.yml
          sed -i "s/^version:.*/version: $VERSION/" ansible/MAIA/Installation/galaxy.yml
          
          # Verify the change
          echo "Updated galaxy.yml version:"
          grep "^version:" ansible/MAIA/Installation/galaxy.yml
      
      - name: Install Ansible collection
        run: |
          ansible-galaxy collection install ansible/MAIA/Installation/
      
      - name: Build Ansible collection
        run: |
          cd ansible/MAIA/Installation/
          ansible-galaxy collection build
          
          # List the built collection
          ls -la *.tar.gz
      
      - name: Publish to Ansible Galaxy
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          cd ansible/MAIA/Installation/
          
          # Publish the collection using the token from secrets
          ansible-galaxy collection publish \
            maia-installation-${VERSION}.tar.gz \
            --token ${{ secrets.ANSIBLE_GALAXY_API_TOKEN }}
        env:
          ANSIBLE_GALAXY_API_TOKEN: ${{ secrets.ANSIBLE_GALAXY_API_TOKEN }}
      
      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: ansible-collection-maia-installation-${{ steps.extract_version.outputs.version }}
          path: ansible/MAIA/Installation/maia-installation-*.tar.gz
