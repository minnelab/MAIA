name: Publish Ansible Collection

on:
  push:
    tags:
      - 'ansible-maia.installation-v*'

jobs:
  publish-ansible-collection:
    name: Build and publish Ansible collection to Galaxy
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core
      
      - name: Extract version from tag
        id: extract_version
        run: |
          # Extract version from tag
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#ansible-maia.installation-v}"
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update galaxy.yml version
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          echo "Updating galaxy.yml with version: $VERSION"
          
          # Update the version field in galaxy.yml
          sed -i "s/^version:.*/version: $VERSION/" ansible/MAIA/Installation/galaxy.yml
          
          # Verify the change
          echo "Updated galaxy.yml version:"
          grep "^version:" ansible/MAIA/Installation/galaxy.yml
      
      - name: Install Ansible collection
        run: |
          # Install collection from local directory to validate structure and dependencies
          ansible-galaxy collection install ansible/MAIA/Installation/
      
      - name: Build Ansible collection
        run: |
          cd ansible/MAIA/Installation/
          ansible-galaxy collection build
          
          # List the built collection
          ls -la *.tar.gz
      
      - name: Publish to Ansible Galaxy
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          cd ansible/MAIA/Installation/
          
          # Publish the collection using the token from environment variable
          ansible-galaxy collection publish \
            maia-installation-${VERSION}.tar.gz \
            --token $ANSIBLE_GALAXY_API_TOKEN
        env:
          ANSIBLE_GALAXY_API_TOKEN: ${{ secrets.ANSIBLE_GALAXY_API_TOKEN }}
      
      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: ansible-collection-maia-installation-${{ steps.extract_version.outputs.version }}
          path: ansible/MAIA/Installation/maia-installation-*.tar.gz
